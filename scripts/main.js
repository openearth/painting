function val2rgbaString(t){"use strict";var e=t.rgba,n=[e.r,e.g,e.b,e.a],i=n[0],r=n[1],a=n[2],o=n[3];return"rgba("+i+","+r+","+a+","+o+")"}function urlParams(){"use strict";for(var t,e=/\+/g,n=/([^&=]+)=?([^&]*)/g,i=function(t){return decodeURIComponent(t.replace(e," "))},r=window.location.search.substring(1),a={};null!==(t=n.exec(r));){var o=i(t[2]),s=null;s="true"===o||"false"!==o&&o,a[i(t[1])]=s}return a}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}!function(t,e){"object"==typeof exports?module.exports=e(t,t.document):"function"==typeof define&&define.amd?define(function(){return e(t,t.document)}):t.Sketch=e(t,t.document)}(this,function(t,e){"use strict";function n(t){return"[object Array]"==Object.prototype.toString.call(t)}function i(t){return"function"==typeof t}function r(t){return"number"==typeof t}function a(t){return"string"==typeof t}function o(t){return k[t]||String.fromCharCode(t)}function s(t,e,n){for(var i in e)!n&&i in t||(t[i]=e[i]);return t}function c(t,e){return function(){t.apply(e,arguments)}}function l(t){var e={};for(var n in t)i(t[n])?e[n]=c(t[n],t):e[n]=t[n];return e}function u(t){function e(e){i(e)&&e.apply(t,[].splice.call(arguments,1))}function n(t){for(O=0;O<tt.length;O++)D=tt[O],a(D)?A[(t?"add":"remove")+"EventListener"].call(A,D,S,!1):i(D)?S=D:A=D}function r(){V(P),P=I(r),Z||(e(t.setup),Z=i(t.setup)),H||(e(t.resize),H=i(t.resize)),t.running&&!U&&(t.dt=(F=+new Date)-t.now,t.millis+=t.dt,t.now=F,e(t.update),Y&&(t.retina&&(t.save(),t.scale(Q,Q)),t.autoclear&&t.clear()),e(t.draw),Y&&t.retina&&t.restore()),U=++U%t.interval}function c(){A=K?t.style:t.canvas,E=K?"px":"",W=t.width||t.element.width,z=t.height||t.element.height,t.fullscreen&&(z=t.height=x.innerHeight,W=t.width=x.innerWidth),t.retina&&Y&&Q&&(A.style.height=z+"px",A.style.width=W+"px",W*=Q,z*=Q),A.height!==z&&(A.height=z+E),A.width!==W&&(A.width=W+E),Z&&e(t.resize)}function u(t,e){return M=e.getBoundingClientRect(),t.x=t.pageX-M.left-(x.scrollX||x.pageXOffset),t.y=t.pageY-M.top-(x.scrollY||x.pageYOffset),t.x*=e.width/M.width,t.y*=e.height/M.height,t}function d(e,n){return u(e,t.element),n=n||{},n.ox=n.x||e.x,n.oy=n.y||e.y,n.x=e.x,n.y=e.y,n.dx=n.x-n.ox,n.dy=n.y-n.oy,n}function h(t){if(t.preventDefault(),j=l(t),j.originalEvent=t,j.touches)for(X.length=j.touches.length,O=0;O<j.touches.length;O++)X[O]=d(j.touches[O],X[O]);else X.length=0,X[0]=d(j,J);return s(J,X[0],!0),j}function p(n){for(n=h(n),G=(q=tt.indexOf(R=n.type))-1,t.dragging=!!/down|start/.test(R)||!/up|end/.test(R)&&t.dragging;G;)a(tt[G])?e(t[tt[G--]],n):a(tt[q])?e(t[tt[q++]],n):G=0}function f(n){N=n.keyCode,B="keyup"==n.type,et[N]=et[o(N)]=!B,e(t[n.type],n)}function m(n){t.autopause&&("blur"==n.type?_:v)(),e(t[n.type],n)}function v(){t.now=+new Date,t.running=!0}function _(){t.running=!1}function C(){(t.running?_:v)()}function T(){Y&&t.clearRect(0,0,t.width,t.height)}function $(){L=t.element.parentNode,O=b.indexOf(t),L&&L.removeChild(t.element),~O&&b.splice(O,1),n(!1),_()}var P,S,A,L,M,O,E,F,D,j,R,N,B,G,q,W,z,U=0,X=[],H=!1,Z=!1,Q=x.devicePixelRatio||1,K=t.type==y,Y=t.type==g,J={x:0,y:0,ox:0,oy:0,dx:0,dy:0},tt=[t.element,p,"mousedown","touchstart",p,"mousemove","touchmove",p,"mouseup","touchend",p,"click",p,"mouseout",p,"mouseover",w,f,"keydown","keyup",x,m,"focus","blur",c,"resize"],et={};for(N in k)et[k[N]]=!1;return s(t,{touches:X,mouse:J,keys:et,dragging:!1,running:!1,millis:0,now:NaN,dt:NaN,destroy:$,toggle:C,clear:T,start:v,stop:_}),b.push(t),t.autostart&&v(),n(!0),c(),r(),t}for(var d,h,p="E LN10 LN2 LOG2E LOG10E PI SQRT1_2 SQRT2 abs acos asin atan ceil cos exp floor log round sin sqrt tan atan2 pow max min".split(" "),f="__hasSketch",m=Math,g="canvas",v="webgl",y="dom",w=e,x=t,b=[],_={fullscreen:!0,autostart:!0,autoclear:!0,autopause:!0,container:w.body,interval:1,globals:!0,retina:!1,type:g},k={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"},C={CANVAS:g,WEB_GL:v,WEBGL:v,DOM:y,instances:b,install:function(t){if(!t[f]){for(var e=0;e<p.length;e++)t[p[e]]=m[p[e]];s(t,{TWO_PI:2*m.PI,HALF_PI:m.PI/2,QUATER_PI:m.PI/4,random:function(t,e){return n(t)?t[~~(m.random()*t.length)]:(r(e)||(e=t||1,t=0),t+m.random()*(e-t))},lerp:function(t,e,n){return t+n*(e-t)},map:function(t,e,n,i,r){return(t-e)/(n-e)*(r-i)+i}}),t[f]=!0}},create:function(t){return t=s(t||{},_),t.globals&&C.install(self),d=t.element=t.element||w.createElement(t.type===y?"div":"canvas"),h=t.context=t.context||function(){switch(t.type){case g:return d.getContext("2d",t);case v:return d.getContext("webgl",t)||d.getContext("experimental-webgl",t);case y:return d.canvas=d}}(),t.exists||(t.container||w.body).appendChild(d),C.augment(h,t)},augment:function(t,e){return e=s(e||{},_),e.element=t.canvas||t,e.element.className+=" sketch",s(t,e,!0),u(t)}},T=["ms","moz","webkit","o"],$=self,P=0,S="AnimationFrame",A="request"+S,L="cancel"+S,I=$[A],V=$[L],M=0;M<T.length&&!I;M++)I=$[T[M]+"Request"+S],V=$[T[M]+"Cancel"+S];return $[A]=I=I||function(t){var e=+new Date,n=m.max(0,16-(e-P)),i=setTimeout(function(){t(e+n)},n);return P=e+n,i},$[L]=V=V||function(t){clearTimeout(t)},C}),L.CanvasOverlay=L.ImageOverlay.extend({options:{opacity:1,id:"",interactive:!0,crossOrigin:!1},initialize:function(t,e){"use strict";t?this._bounds=L.latLngBounds(t):this._bounds=null,L.setOptions(this,e)},_initImage:function(){"use strict";var t;t=this.options.el?this._image=this.options.el:this.options.id?this._image=document.getElementById(this.options.id):this._image=L.DomUtil.create("canvas","leaflet-image-layer "+(this._zoomAnimated?"leaflet-zoom-animated":"")),t.onselectstart=L.Util.falseFn,t.onmousemove=L.Util.falseFn,t.onload=L.bind(this.fire,this,"load"),this.options.crossOrigin&&(t.crossOrigin="")},_reset:function(){"use strict";L.ImageOverlay.prototype._reset.call(this);var t=this._image;t.width!==this.options.width&&(t.width=this.options.width),t.height!==this.options.height&&(t.height=this.options.height)}}),L.canvasOverlay=function(t,e){"use strict";return new L.CanvasOverlay(t,e)},function(){"use strict";var t=1;Object.defineProperty(Object.prototype,"__uniqueId",{writable:!0}),Object.defineProperty(Object.prototype,"uniqueId",{get:function(){return void 0===this.__uniqueId&&(this.__uniqueId=t++),this.__uniqueId}})}(),function(){"use strict";Vue.component("map-controls",{template:"#map-controls-template",props:{map:{type:Object}},data:function(){return{playbackRate:1}},mounted:function(){var t=$(this.$el).find("#playback-rate");t.attr("min",.1),t.attr("max",3),t.attr("step",.1)},computed:{locked:{get:function(){var t=!0,e=this.map;return _.has(e,"dragging")&&(t=!e.dragging.enabled()),t},set:function(t){console.log("locking map",t),t?this.lockMap():this.unlockMap()},cache:!1},particleSize:{get:function(){return _.get(this.$root.$refs,"particleComponent.radius")},set:function(t){this.$root.$refs.particleComponent.radius=parseFloat(t)},cache:!1},computedPlaybackRate:{get:function(){var t=$("#uv-video")[0],e=_.get(t,"playbackRate",this.playbackRate);return e},set:function(t){this.playbackRate=t;var e=$("#uv-video")[0];e.playbackRate=parseFloat(t)},cache:!1}},methods:{lockMap:function(){var t=this.map;t.dragging.disable(),t.touchZoom.disable(),t.doubleClickZoom.disable(),t.scrollWheelZoom.disable(),t.tap&&t.tap.disable()},unlockMap:function(){var t=this.map;t.dragging.enable(),t.touchZoom.enable(),t.doubleClickZoom.enable(),t.scrollWheelZoom.enable(),t.tap&&t.tap.enable()}}}),Vue.component("toggle-controls",{template:"#toggle-controls-template",props:{sketch:{type:CanvasRenderingContext2D}},data:function(){return{toggleButtons:[{id:"maptoggle",icon:"fa-map-o",type:"toggle",banned:"mapControls.locked"},{id:"cleartoggle",icon:"fa-tint",type:"toggle",banned:"modelCanvas.clearAfterRender"}],actionButtons:[{id:"clearcanvas",icon:"fa-eraser",type:"button",actions:["modelCanvas.clear","particleComponent.clear"]},{id:"addparticle",icon:"fa-tencent-weibo",type:"button",actions:["particleComponent.add"]},{id:"addgrid",icon:"fa-th",type:"button",actions:["drawingCanvas.grid"]},{id:"addquiver",icon:"fa-long-arrow-right",type:"button",actions:["drawingCanvas.quiver"]}]}},mounted:function(){var t=this,e=L.Control.extend({options:{position:"topright"},onAdd:function(){var e=t.$el;return e}});this.controls=[new e({})]},methods:{toggle:function(t){var e=this.$root;_.set(e.$refs,t.banned,!_.get(e.$refs,t.banned))},action:function(t){var e=this.$root;_.each(t.actions,function(t){_.get(e.$refs,t)()})},isBanned:function(t){var e=this.$root;return _.get(e.$refs,t.banned)},deferredMountedTo:function(t){var e=this;_.forEach(this.controls,function(e){e.addTo(t)}),_.forEach(this.$children,function(t){t.deferredMountedTo(e.$drawToggle)})}}}),Vue.component("canvas-layer",{template:"#canvas-layer-template",props:{model:{type:Object}},watch:{bounds:function(){this.setBounds()}},mounted:function(){var t=this.bounds;this.$drawingLayer=L.canvasOverlay(t,{el:this.$el,width:1024,height:1024})},computed:{bounds:{get:function(){var t=L.latLngBounds(L.latLng(0,0),L.latLng(1,1));if(_.has(this,"model.extent")){var e=this.model,n=L.latLng(e.extent.sw[0],e.extent.sw[1]),i=L.latLng(e.extent.ne[0],e.extent.ne[1]);t=L.latLngBounds(n,i)}return t},cache:!1}},methods:{deferredMountedTo:function(t){var e=this;this.$drawingLayer.addTo(t),_.forEach(this.$children,function(t){t.deferredMountedTo(e.$drawingLayer)})},setBounds:function(){this.$drawingLayer.setBounds(this.bounds)}}})}(),function(){"use strict";var t=Vue.component("station-icon",{template:"#station-icon-template",props:{feature:{type:Object}},data:function(){return{}},methods:{},mounted:function(){}});Vue.component("realtime-layer",{template:"#realtime-layer-template",props:{model:{type:Object},repository:{type:String,"default":""}},data:function(){return{points:[],markerGroup:null,layerGroup:null}},watch:{points:function(){this.clearMarkers(),this.createMarkers()},model:function(){this.fetchPoints()}},components:{"station-icon":t},mounted:function(){this.fetchPoints()},computed:{},methods:{fetchPoints:function(){var t=this,e="data/points";if(""!==this.repository){if(_.isNil(this.model))return;e=urljoin(this.repository,this.model.realtime.points)}fetch(e).then(function(t){return t.json()}).then(function(e){_.each(e.features,function(t){t.properties.selected=!1}),Vue.set(t,"points",e)})},deferredMountedTo:function(t){this.layerGroup=L.layerGroup([]),this.layerGroup.addTo(t),this.markerGroup&&this.layerGroup.addLayer(this.markerGroup)},createMarkers:function(){var e=this,n=L.markerClusterGroup({iconCreateFunction:function(t){var e="cluster-"+t._leaflet_id,n=L.divIcon({html:'<div class="cluster-icon" id="'+e+'"></div>'});return t.on("add",function(){var n=t.getAllChildMarkers(),i=_.map(n,function(t){return _.get(t,"options.feature.properties.locationColor","#eebb33")}),r=_.toPairs(_.groupBy(i)),a=d3.pie().value(function(t){return t[1].length}),o=20,s=20,c=Math.min(o,s)/2,l=d3.arc().outerRadius(c).innerRadius(0),u=d3.select("#"+e).append("svg").attr("width",o).attr("height",s).append("g").attr("transform","translate("+o/2+","+s/2+")"),d=u.selectAll(".arc").data(a(r)).enter().append("g").attr("class","arc");d.append("path").attr("d",l).style("fill",function(t){return t.data[0]})}),n}});_.each(this.points.features,function(i,r){var a=_.get(i,"properties.lat",i.geometry.coordinates[1]),o=_.get(i,"properties.lon",i.geometry.coordinates[0]),s=L.latLng(a,o),c="station-icon-"+i.id,l=L.divIcon({html:'<station-icon :feature="points.features['+r+']" id="'+c+'"></station-icon>',iconSize:L.point(20,20)}),u=L.marker(s,{icon:l,feature:i});u.on("click",function(t){e.setChart(i,t)}),u.on("add",function(){var n=$(u.getElement()).find("station-icon"),r=new t({parent:e,propsData:{feature:i}});r.$mount(n[0])}),n.addLayer(u)}),this.markerGroup=n;var i=_.first(_.filter(this.points.features,function(t){return _.get(t,"properties.featured",!0)}));this.setChart(i),_.isNil(this.layerGroup)||this.layerGroup.addLayer(n)},clearMarkers:function(){this.layerGroup&&this.layerGroup.clearLayers()},setChart:function(t){_.each(this.points.features,function(t){t.properties.selected=!1}),t.properties.selected=!0,bus.$emit("feature-selected",t)}}})}();var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),AdvectionFilter;!function(){"use strict";var t="\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nuniform mat3 projectionMatrix;\nuniform mat3 filterMatrix;\nvarying vec2 vTextureCoord;\nvarying vec2 vFilterCoord;\n\nvoid main(void)\n{\n   gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n   vFilterCoord = ( filterMatrix * vec3( aTextureCoord, 1.0)  ).xy;\n   vTextureCoord = aTextureCoord;\n}\n",e="\nvarying vec2 vFilterCoord;\nvarying vec2 vTextureCoord;\nuniform float decay;\nuniform vec2 scale;\nuniform bool flipv;\nuniform sampler2D uUVSampler;\nuniform sampler2D uSampler;\n\nbool isNaN(float val)\n{\n  return (val <= 0.0 || 0.0 <= val) ? false : true;\n}\n\nvoid main(void)\n{\n  // lookup in 0-1 space\n  vec2 coord = vFilterCoord;\n  // invert y if flipping\n  if (flipv) {\n    coord.y = 1.0 - coord.y;\n  }\n\n  vec4 map =  texture2D(uUVSampler, coord);\n  map -= 0.5;\n  map.xy *= scale;\n  // recompute scale if flipped\n  if (flipv) {\n    map.y = - map.y;\n  }\n\n\n\n  vec2 lookup = vec2(vTextureCoord.x - map.x, vTextureCoord.y - map.y);\n\n\n  vec4 color = texture2D(uSampler, lookup);\n  // I expected that I would have to apply this to the .a only..\n  color = vec4(color.rgb * decay, color.a * decay);\n  gl_FragColor = color;\n  if (map.z > 0.0) {\n    gl_FragColor *= 0.0;\n  }\n}";AdvectionFilter=function(n){function i(n,r){_classCallCheck(this,i);var a=new PIXI.Matrix;n.renderable=!1;var o=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,e));o.maskSprite=n,o.maskMatrix=a,o.uniforms.uUVSampler=n.texture,o.uniforms.filterMatrix=a.toArray(!0);var s=_.get(r,"scale",10);o.scale=new PIXI.Point(s,s);var c=_.get(r,"flipv",!1);o.flipv=c;var l=_.get(r,"decay",1);return o.decay=l,o}return _inherits(i,n),_createClass(i,[{key:"apply",value:function(t,e,n){_.isNaN(this.maskSprite.worldTransform.a)&&console.warn("aaahh");var i=1/n.destinationFrame.width*(n.size.width/e.size.width);this.uniforms.filterMatrix=t.calculateSpriteMatrix(this.maskMatrix,this.maskSprite),this.uniforms.scale.x=this.scale.x*i,this.uniforms.scale.y=this.scale.y*i,this.uniforms.flipv=this.flipv,this.uniforms.decay=this.decay,t.applyFilter(this,e,n)}},{key:"map",get:function(){return this.uniforms.uUVSampler},set:function(t){this.uniforms.uUVSampler=t}}]),i}(PIXI.Filter)}();var sketch;!function(){"use strict";Vue.component("drawing-canvas",{template:"<div></div>",data:function(){return{canvas:null,sketch:null}},mounted:function(){var t=this;this.addDrawing(),this.$nextTick(function(){bus.$emit("drawing-canvas-created",t),bus.$on("model-selected",t.clear)})},methods:{clear:function(){this.sketch.clear()},deferredMountedTo:function(t){this.canvas=t._image,this.addDrawing()},addDrawing:function(){sketch=Sketch.create({element:this.canvas,container:null,autoclear:!1,fullscreen:!1,exists:!0,palette:["black","green"],radius:3,painting:!1,hasDragged:!0,setup:function(){},update:function(){},keydown:function(t){bus.$emit("drawing-keydown",t,this)},mouseup:function(){},mousedown:function(){this.hasDragged=!1},mousemove:function(){this.hasDragged=!0},click:function(t){this.fillStyle=this.palette[Math.floor(Math.random()*this.palette.length)],this.beginPath();var e=t.x,n=t.y,i=1;this.arc(e,n,i,0,2*Math.PI),this.fill(),bus.$emit("drawing-click",this)},touchmove:function(){var t=Modernizr.touch||this.keys.SHIFT;if(t){for(var e,n=this.touches.length-1;n>=0;n--)e=this.touches[n],this.lineCap="round",this.lineJoin="round",this.strokeStyle=this.palette[Math.floor(Math.random()*this.palette.length)],this.lineWidth=this.radius,this.beginPath(),this.moveTo(e.ox,e.oy),this.lineTo(e.x,e.y),this.stroke();bus.$emit("drawing-touchmove",this)}}}),Vue.set(this,"sketch",sketch),this.$nextTick(function(){bus.$emit("sketch-created",sketch)})},grid:function(){var t=this.sketch;_.each(_.range(0,1024,Math.pow(2,7)),function(e){t.strokeStyle="black",t.beginPath(),t.moveTo(e,0),t.lineTo(e,1024),t.closePath(),t.stroke(),t.beginPath(),t.moveTo(0,e),t.lineTo(1024,e),t.closePath(),t.stroke()})},quiver:function(){var t=this.sketch;_.each(_.range(0,100),function(){var e=1024*Math.random(),n=1024*Math.random();t.strokeStyle="white",t.beginPath(),t.arc(e,n,1,0,2*Math.PI),t.closePath(),t.stroke()})}}}),$(function(){$("#images a.thumbnail").click(function(t){var e=$(t.currentTarget).find("img").attr("src"),n=new Image;n.onload=function(){sketch.drawImage(n,0,0)},n.src=e,t.preventDefault()})})}(),function(){"use strict";Vue.component("model-details",{template:"#model-details-template",props:["model"],data:function(){return{}},methods:{select:function(){console.log("selecting",this.model),bus.$emit("model-selected",this.model)}}}),Vue.component("models-overview",{template:"#models-overview-template",props:{repository:{type:String,"default":""}},data:function(){return{models:[]}},mounted:function(){var t=this,e=""===this.repository?"data/models.json":"models";fetch(urljoin(this.repository,e)).then(function(t){return t.json()}).then(function(e){t.models=_.get(e,"models",e);var n=_.first(_.filter(t.models,["id",t.$root.settings.model]));_.isNil(n)&&(n=_.first(t.models)),t.selectModel(n)})["catch"](function(t){console.warn("parsing failed",t)})},methods:{selectModel:function(t){var e=new CustomEvent("model-selected",{detail:t});document.dispatchEvent(e),bus.$emit("model-selected",t)}}})}(),function(){"use strict";function t(t,e,n){this.model=t,this.canvas=e,this.uv=n,this.width=e.width,this.height=e.height,this.particleAlpha=.8,this.replace=!0,this.particles=[],this.color="rgba(255, 91, 126, 0.8)",this.r=1,this.fade=.95,this.counter=0,this.state="STOPPED",this.offScreen=document.createElement("canvas"),this.offScreen.width=this.canvas.width,this.offScreen.height=this.canvas.height}t.prototype.startAnimate=function(){function t(){"STOPPED"!==this.state&&(requestAnimationFrame(t.bind(this)),i=Date.now(),e=i-r,e<a||this.particles.length&&(this.step(60/n),this.render(),r=i-e%a))}var e,n=15,i=Date.now(),r=Date.now(),a=1e3/n;this.state="STARTED",t.bind(this)()},t.prototype.stopAnimate=function(){this.state="STOPPED"},t.prototype.create=function(){var t=new PIXI.Sprite;return t.anchor.set(.5),t.alpha=this.particleAlpha,t.x=Math.random()*this.width,t.y=Math.random()*this.height,t},t.prototype.clear=function(){this.particles.splice(0);var t=this.canvas.getContext("2d"),e=this.canvas.width,n=this.canvas.height,i=this.offScreen.getContext("2d");i.clearRect(0,0,e,n),t.clearRect(0,0,e,n)},t.prototype.culling=function(t){for(var e=this.particles.length,n=t,i=e-1;i>=n;i--)_.pullAt(this.particles,i),this.sprites.removeChildAt(i);for(var r=0;r<n-e;r++){var a=this.create();this.particles.push(a)}},t.prototype.step=function(t){var e=this;if(this.particles.length&&!this.uv.paused&&!this.uv.ended){var n=$("#uv-canvas")[0],i=n.getContext("2d"),r=n.width,a=n.height,o=i.getImageData(0,0,r,a);_.each(this.particles,function(n){var i=4*(Math.round(a-n.position.y)*r+Math.round(n.position.x)),s=o.data[i+0]/255-.5,c=o.data[i+1]/255-.5;c*=e.model.flipv?1:-1;var l=o.data[i+2]/255>.5;l=l||Math.abs(s)+Math.abs(c)===0,n.position.x=n.position.x+s*e.model.uniforms.scale*t,n.position.y=n.position.y+c*e.model.uniforms.scale*t,l=l||n.position.x>r,l=l||n.position.x<0,l=l||n.position.y>a-1,l=l||n.position.y<10,l=l||isNaN(n.position.x),l=l||isNaN(n.position.y);var u=Math.atan2(c,s)-.5*Math.PI,d=u-n.rotation,h=.1;if(Math.abs(d)>h&&(d=d>0?h:-h),n.rotation+=d,l&&(_.pull(e.particles,n),e.replace)){var p=e.create();e.particles.push(p)}},this),this.counter++}},t.prototype.render=function(){var t=this.canvas.getContext("2d"),e=this.canvas.width,n=this.canvas.height,i=this.offScreen.getContext("2d");if(this.counter%20===0){for(var r=t.getImageData(0,0,e,n),a=r.data,o=this.fade,s=0,c=a.length;s<c;s+=4){var l=a[s+3];l<=1-o&&(a[s+3]=0)}i.putImageData(r,0,0)}else i.globalCompositeOperation="copy",i.drawImage(this.canvas,0,0);t.fillStyle="white",t.clearRect(0,0,e,n),t.globalAlpha=this.fade,t.drawImage(this.offScreen,0,0),t.globalAlpha=1,t.fillStyle=this.color,t.beginPath();var u=this.r;_.each(this.particles,function(e){t.moveTo(e.x+u,e.y),t.arc(e.x,e.y,u,0,2*Math.PI)}),t.closePath(),t.fill()},Vue.component("particle-component",{template:"#particle-component-template",props:["model"],data:function(){return{particles:null,pipeline:null,stage:null,renderer:null,canvas:null}},mounted:function(){bus.$on("model-selected",this.resetParticles)},watch:{"model.uv":"resetParticles",pipeline:"resetParticles"},computed:{radius:{get:function(){return _.get(this.particles,"r")},set:function(t){this.particles.r=t},cache:!1},width:{get:function(){return _.get(this,"canvas.width")}},height:{get:function(){return _.get(this,"canvas.height")}}},methods:{deferredMountedTo:function(e){if(this.canvas=e._image,!_.isNil(this.model)){var n=$("#uv-"+this.model.uv.tag)[0];this.particles&&this.particles.stopAnimate(),Vue.set(this,"particles",new t(this.model,this.canvas,n,{radius:this.radius})),this.particles.startAnimate()}},resetParticles:function(){if(!_.isNil(this.model)&&!_.isNil(this.canvas)){var e=$("#uv-"+this.model.uv.tag)[0];this.clear(),Vue.set(this,"particles",new t(this.model,this.canvas,e)),this.particles.startAnimate(),this.add()}},add:function(){_.isNil(this.model)||_.isNil(this.particles)||this.particles.culling(this.particles.particles.length+50)},removeParticles:function(){this.particles&&this.particles.clear()},clear:function(){this.removeParticles()}}})}(),function(){"use strict";Vue.component("uv-source",{template:"#uv-source-template",props:{model:{type:Object,required:!1},repository:{type:String,"default":""}},data:function(){return{loaded:!1}},mounted:function(){function t(){if(requestAnimationFrame(t.bind(this)),i=Date.now(),e=i-r,e>a){if(r=i-e%a,!this.video)return;if(!this.uvctx)return;var n=this.video.width,s=this.video.height;this.uvctx.drawImage(this.video,0,0,n,s),o++}}var e,n=3,i=Date.now(),r=Date.now(),a=1e3/n,o=0;t.bind(this)()},watch:{uv:function(t){var e=this,n=this.video;n.src=urljoin(this.repository,t.src),n.setAttribute("crossorigin","anonymous"),n.height=t.height,n.width=t.width,this.loaded=!1,"video"===this.model.uv.tag&&(this.video.currentTime=this.video.currentTime,$(this.video).bind("loadeddata",function(){Vue.set(e.model,"duration",e.video.duration),e.loaded||(e.loaded=!0,bus.$emit("video-loaded",n))}),$(this.video).bind("timeupdate",function(){Vue.set(e.model,"currentTime",e.video.currentTime)})),n.load()}},computed:{tag:{get:function(){return _.get(this,"model.uv.tag","video")},cache:!1},uv:{get:function(){return this.model?this.model.uv:null},cache:!1},video:{get:function(){return document.getElementById("uv-video")},cache:!1},uvctx:{get:function(){var t=document.getElementById("uv-canvas");return t.getContext("2d")},cache:!1},img:{get:function(){return document.getElementById("uv-img")},cache:!1}}}),Vue.component("model-canvas",{template:"<div>model</div>",props:{model:{type:Object,required:!1},sketch:{type:CanvasRenderingContext2D,required:!1}},data:function(){return{state:"STOPPED",drawingTexture:null,videoElement:null,videoSprite:null,stage:null,renderer:null,renderTextureFrom:null,renderTextureTo:null,pipeline:null,advectionFilter:null,clearAfterRender:!0}},mounted:function(){var t=this;bus.$on("video-loaded",function(t){this.createVideoTexture(t),this.checkAndRun()}.bind(this)),Vue.nextTick(function(){bus.$on("model-selected",t.clear)})},computed:{width:{get:function(){return _.get(this,"canvas.width")}},height:{get:function(){return _.get(this,"canvas.height")}},drawing:{get:function(){return _.get(this,"sketch")},cache:!1}},watch:{"model.uniforms":function(){this.updateUniforms()},drawing:function(t){t&&(this.createDrawingTexture(t),this.checkAndRun())}},methods:{checkAndRun:function(){this.videoSprite&&this.drawingSprite&&(this.advectionFilter||(this.createFilter(),this.startAnimate(),this.updateUniforms()))},clear:function(){var t=new PIXI.Container;this.renderer.render(t,this.renderTextureTo,!0),this.renderer.render(t,this.renderTextureFrom,!0)},deferredMountedTo:function(t){this.canvas=t._image,this.createRenderer()},createRenderer:function(){var t=new PIXI.WebGLRenderer(this.width,this.height,{view:this.canvas,transparent:!0,clearBeforeRender:!1,preserveDrawingBuffer:!1}),e=new PIXI.Container,n=new PIXI.Container;Vue.set(this,"pipeline",n),Vue.set(this,"stage",e),Vue.set(this,"renderer",t)},createVideoTexture:function(t){var e=PIXI.Texture.fromVideo(t),n=new PIXI.Sprite(e);if(n.width=this.width,n.height=this.height,this.videoSprite){var i=this.stage.getChildIndex(this.videoSprite);this.stage.removeChildAt(i),this.stage.addChildAt(n,i)}else this.stage.addChild(n);this.videoSprite=n,this.advectionFilter&&(this.advectionFilter.map=n.texture),n.renderable=!1,this.stage.addChild(this.videoSprite)},createDrawingTexture:function(t){if(!t)return void console.warn("Expected a drawing canvas");var e=t,n=PIXI.Texture.fromCanvas(t.element),i=new PIXI.Sprite(n);this.drawingContext=e,this.drawingSprite=i,this.drawingTexture=n},updateUniforms:function(){if(this.advectionFilter&&this.model){var t=this.model;this.advectionFilter.scale.x=t.uniforms.scale,this.advectionFilter.scale.y=t.uniforms.scale,this.advectionFilter.flipv=t.uniforms.flipv,this.advectionFilter.decay=t.uniforms.decay}},createFilter:function(){var t=this,e=this.videoSprite,n=this.width,i=this.height;this.stage.addChild(this.pipeline),this.pipeline.addChild(this.drawingSprite);var r=new AdvectionFilter(e,{scale:1,flipv:!1,decay:.99,upwind:!1});this.stage.addChild(e),this.pipeline.filters=[r];var a=PIXI.RenderTexture.create(n,i),o=new PIXI.Sprite(a),s=PIXI.RenderTexture.create(n,i);this.renderTextureFrom=a,this.renderTextureTo=s,this.renderSpriteFrom=o,this.pipeline.addChild(o),this.pipeline.addChild(this.drawingSprite),this.advectionFilter=r,this.$nextTick(function(){bus.$emit("pipeline-created",t.pipeline)})},stopAnimage:function(){this.state="STOPPED"},startAnimate:function(){function t(){if("STOPPED"!==l&&(requestAnimationFrame(t.bind(this)),e=this.videoSprite,e.texture.valid&&e.texture.baseTexture.hasLoaded)){var h=e.texture.baseTexture.source;if(!(h.readyState<h.HAVE_ENOUGH_DATA)&&s.children.indexOf(e)!==-1){n.update(),i.render(s),i.render(s,r,!0),o.texture=r;var p=a;a=r,r=p,this.clearAfterRender&&(i.render(d,r,!0),c.clearRect(0,0,u.element.width,u.element.height))}}}this.state="STARTED";var e=this.videoSprite,n=this.drawingTexture,i=this.renderer,r=this.renderTextureTo,a=this.renderTextureFrom,o=this.renderSpriteFrom,s=this.stage,c=this.drawingContext,l=this.state,u=this.drawing,d=new PIXI.Container;t.bind(this)()}}})}(),function(){"use strict";function t(){var t=[];d3.selectAll("circle.active").each(function(e){var n=d3.rgb(255*e.rgb[0],255*e.rgb[1],255*e.rgb[2]);t.push(n)}),_.isNil(sketch)||(sketch.palette=t)}Vue.component("painting-palettes",{template:"#paintings-template",data:function(){return{paintings:[]}},mounted:function(){var t=this;fetch("data/paintings.json").then(function(t){return t.json()}).then(function(e){t.paintings=e,t.select(t.paintings[0])})},methods:{select:function(t){bus.$emit("palette-selected",t.palette)}}}),Vue.component("palette-chart",{template:"#palette-chart-template",data:function(){return{}},props:{palette:{type:Array,"default":function(){return[]}}},mounted:function(){this.$watch("palette",function(){this.updateChart(),this.selectAll()})},computed:{svg:{get:function(){return d3.select("#palette").select("svg")},cache:!1}},methods:{deselectAll:function(){var e=this.svg,n=e.select("g");n.selectAll("circle").classed("active",!1),t()},selectAll:function(){var e=this.svg,n=e.select("g");n.selectAll("circle").classed("active",!0),t()},updateChart:function(){var e=260,n=200,i=this.svg,r=i.select("g");i.attr("width",e).attr("height",n);var a=d3.scaleLinear().range([0,e]).domain([-.1,1.1]).nice(),o=d3.scaleLinear().range([n,0]).domain([-.1,1.1]).nice();r.selectAll("circle").remove(),r.selectAll("circle").data(this.palette).enter().append("circle").attr("cx",function(t){return a(t.x)}).attr("cy",function(t){return o(t.y)}).attr("r",10).style("fill",function(t){return d3.rgb(255*t.rgb[0],255*t.rgb[1],255*t.rgb[2])}).on("click",function(){d3.select(this).classed("active",!d3.select(this).classed("active")),t()}),this.selectAll()}}}),document.addEventListener("model-loaded",function(){t()})}(),function(){"use strict";Vue.component("key-bindings",{template:"#key-bindings-template",data:function(){var t=this,e=this.$root;return{keyBindings:[{key:"p",description:"Particles",method:function(){_.has(e,"$refs.particleComponent.add")&&e.$refs.particleComponent.add()},arguments:{}},{key:"c",method:function(){t.clear()},description:"Clear canvas",arguments:{}},{key:"q",description:"Quiver like plot",method:function(){e.$refs.drawingCanvas.quiver()}},{key:"g",description:"Grid plot",method:function(){e.$refs.drawingCanvas.grid()}}]}},mounted:function(){window.addEventListener("keyup",this.keyUp),bus.$on("drawing-keydown",this.drawingKey)},methods:{drawingKey:function(t,e){var n=_.first(_.filter(this.keyBindings,["key",t.key]));_.isNil(n)||n.method(t,e)},keyUp:function(t){var e=_.first(_.filter(this.keyBindings,["key",t.key]));_.isNil(e)||e.method(e.arguments)},clear:function(){var t=this.$root;_.has(t.$refs,"drawingCanvas")?t.$refs.drawingCanvas.clear():console.warn("Expected drawingCanvas on",t.$refs),_.has(t.$refs,"modelCanvas")?t.$refs.modelCanvas.clear():console.warn("Expected modelCanvas on",t.$refs),_.has(t.$refs,"particleComponent")?t.$refs.particleComponent.clear():console.warn("Expected particleCanvas on",t.$refs)}}})}(),function(){"use strict";Vue.component("story-container",{template:"#story-container-template",data:function(){return{storyUrl:"data/stories/ecomare.json",story:null}},mounted:function(){var t=this;this.$nextTick(function(){var e=new ScrollMagic.Controller({container:t.$el,loglevel:3});console.log("adding story to ",t.$el);var n=t.$root;fetch(t.storyUrl).then(function(t){return t.json()}).then(function(i){Vue.set(t,"story",i),t.$nextTick(function(){var r=t.$el.getElementsByClassName("story-item");_.each(r,function(t,r){var a=i.items[r];console.log("combining",t,"with",a,t.clientHeight);var o=new ScrollMagic.Scene({triggerElement:t,duration:t.clientHeight}).on("enter",function(){console.log("entering item",a),_.has(a,"latlng")&&n.$refs.map.mapObject.flyTo(L.latLng(a.latlng),a.zoom)}).addIndicators().addTo(e);console.log("add scene",o)});var a=Array.from(t.$el.getElementsByClassName("jssor-slider-container"));_.map(a,function(t){var e=new $JssorSlider$(t.id,{$AutoPlay:!0});return e})})})})}})}(),function(){"use strict";Vue.component("chart-container",{template:"#chart-container-template",props:{model:{type:Object},repository:{type:String,"default":""}},data:function(){return{series:[],limits:[],feature:null,chart:null}},mounted:function(){var t=this;this.createChart(),bus.$on("feature-selected",function(e){t.feature=e;var n="data/details/"+_.get(e,"properties.locationCode",e.id);
""!==t.repository&&(n=urljoin(t.repository,"data/details",e.id)),fetch(n).then(function(t){return t.json()}).then(function(e){Vue.set(t,"series",e.series),Vue.set(t,"limits",_.get(e,"limits",[]))})}),this.$nextTick(function(){var t=this;window.addEventListener("resize",function(){t.createChart(),t.updateChart()}),this.updateChart()})},watch:{progress:function(t){if(!_.isNaN(t)){var e=[{x:t,y:0},{x:t,y:1}];this.chart.pathProgress.datum(e).transition().attr("d",this.chart.lineProgress)}},series:function(){this.updateChart()},model:function(){this.updateChart()}},computed:{progress:{cache:!1,get:function(){if(!_.has(this.model,"currentTime"))return 0;var t=this.model.currentTime/this.model.duration;return t}},name:{cache:!1,get:function(){return _.get(this.feature,"properties.name")}}},methods:{updateChart:function(){var t=this;if(this.model){var e=_.map(this.model.extent.time,d3.isoParse);if(this.chart.xTime.domain(e),this.chart.yWaterlevel.domain(_.get(this.model.extent,"waterlevel",[0,1])),this.chart.xAxis.call(d3.axisBottom(this.chart.xTime)),this.chart.yAxis.call(d3.axisLeft(this.chart.yWaterlevel).ticks(5)),this.series.length){this.chart.g.selectAll(".series").remove(),this.chart.g.selectAll(".limits").remove(),this.chart.g.selectAll(".limits").data(this.limits).enter().append("rect").attr("class","limits").attr("x",function(){var e=d3.isoParse(t.model.extent.time[0]);return t.chart.xTime(e)}).attr("y",function(e){var n=t.model.extent.waterlevel[1];return _.isNil(e.to)||(n=e.to/100),t.chart.yWaterlevel(n)}).attr("width",function(){var e=d3.isoParse(t.model.extent.time[1]),n=d3.isoParse(t.model.extent.time[0]),i=t.chart.xTime(e)-t.chart.xTime(n);return i}).attr("height",function(e){var n=t.model.extent.waterlevel[0];_.isNil(e.from)||(n=e.from/100);var i=t.model.extent.waterlevel[1];_.isNil(e.to)||(i=e.to/100);var r=t.chart.yWaterlevel(n)-t.chart.yWaterlevel(i);return r<0?0:r}).style("fill",function(t){return t.color}).style("opacity",.2);var n=this.chart.g.selectAll(".series").data(this.series).enter().append("g").attr("class","series"),i=d3.line().x(function(e){var n=d3.isoParse(e.date||e.dateTime),i=t.chart.xTime(n);return i}).y(function(e){var n=t.chart.yWaterlevel(e.s1||e.value/100);return n});n.append("path").attr("class","line waterlevel clipped").attr("d",function(t){return i(t.data)}).style("stroke",function(t){return t.color})}}},createChart:function(){var t={top:14,right:24,bottom:28,left:34},e=this.$el.clientWidth-t.left-t.right,n=this.$el.clientHeight-t.top-t.bottom,i=d3.scaleTime().range([0,e]),r=d3.scaleLinear().range([0,e]),a=d3.scaleLinear().range([n,0]),o=d3.scaleLinear().range([n,0]),s=$(this.$el).find("svg")[0],c=d3.select(s);c.selectAll("*").remove(),c.attr("width",e+t.left+t.right).attr("height",n+t.top+t.bottom);var l=c.append("g").attr("transform","translate("+t.left+","+t.top+")");l.append("clipPath").attr("id","clip").append("rect").attr("width",e).attr("height",n);var u=l.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+n+")"),d=l.append("g").attr("class","axis axis--y");d.append("text").attr("class","axis-title").attr("transform","rotate(-90)").attr("y",-t.left).attr("dy","1em").attr("x",-n/2).style("text-anchor","middle").text("water hoogte [m]");var h=[{x:this.progress,y:0},{x:this.progress,y:1}],p=d3.line().x(function(t){return r(t.x)}).y(function(t){return a(t.y)}),f=l.datum(h).append("path").attr("class","line").attr("d",p),m={svg:c,g:l,xTime:i,xLinear:r,yWaterlevel:o,yLinear:a,width:e,height:n,xAxis:u,yAxis:d,lineProgress:p,pathProgress:f};Vue.set(this,"chart",m)}}})}(),function(){"use strict";Vue.component("wind-rose",{template:"#wind-rose-template",props:{model:{type:Object},repository:{type:String,"default":""}},data:function(){return{series:[],path:null,line:null}},watch:{"model.realtime.wind":function(){this.updateWindSeries()},"model.currentTime":function(t){if(this.series.length){var e=moment(this.model.extent.time[0]),n=moment(this.model.extent.time[1]),i=n-e,r=t/_.get(this.model,"duration",1),a=e+r*i,o=d3.bisector(function(t){return t.date}).left,s=o(this.series,a),c=this.series[s];this.arrow.datum([{u:0,v:0},c]).transition().attr("d",this.line)}},series:function(t){this.path.datum(t).attr("class","line").attr("d",this.line)}},mounted:function(){!_.isNil(this.model)&&_.has(this.model,"realtime.wind")&&this.updateWindSeries(),this.updateAxis()},methods:{updateAxis:function(){var t=this.$el.querySelector(".wind-rose"),e=d3.select(t),n=246,i=246,r=Math.min(n,i)/2-30,a=d3.scaleLinear().domain([0,10]).range([0,r]),o=d3.radialLine().radius(function(t){var e=Math.sqrt(Math.pow(t.u,2)+Math.pow(t.v,2));return a(e)}).angle(function(t){var e=Math.atan2(t.v,t.u);return e});this.line=o,e.attr("width",n).attr("height",i);var s=e.append("g").attr("transform","translate("+n/2+","+i/2+")"),c=s.append("g").attr("class","r axis").selectAll("g").data(a.ticks(5).slice(1)).enter().append("g");c.append("circle").attr("r",a),c.append("text").attr("y",function(t){return-a(t)-4}).attr("transform","rotate(15)").style("text-anchor","middle").text(function(t){return t.toFixed(0)});var l=s.append("g").attr("class","a axis").selectAll("g").data(d3.range(0,360,30)).enter().append("g").attr("transform",function(t){return"rotate("+-t+")"});l.append("line").attr("x2",r),l.append("text").attr("x",r+6).attr("dy",".35em").style("text-anchor",function(t){return t<270&&t>90?"end":null}).attr("transform",function(t){return t<270&&t>90?"rotate(180 "+(r+6)+",0)":null}).text(function(t){return t+"Â°"});var u=s.append("path").datum(this.series).attr("class","line").attr("d",o);this.path=u;var d=s.append("path").attr("class","arrow");this.arrow=d},updateWindSeries:function(){var t=this,e=urljoin(this.repository,this.model.realtime.wind);fetch(e).then(function(t){return t.json()}).then(function(e){_.each(e,function(t){t.date=moment.utc(t.t)}),Vue.set(t,"series",e)})}}})}();var _slicedToArray=function(){function t(t,e){var n=[],i=!0,r=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(i=(o=s.next()).done)&&(n.push(o.value),!e||n.length!==e);i=!0);}catch(c){r=!0,a=c}finally{try{!i&&s["return"]&&s["return"]()}finally{if(r)throw a}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),app,bus;!function(){"use strict";var t={hex:"#194d33",hsl:{h:150,s:.5,l:.2,a:1},hsv:{h:150,s:.66,v:.3,a:1},rgba:{r:25,g:77,b:51,a:1},a:1};$(document).ready(function(){bus=new Vue;var e=_.get(Vuetify,"default",Vuetify);Vue.use(e);var n={"v-sidebar":"VSidebar"};_.each(_.toPairs(n),function(t){var e=_slicedToArray(t,2),n=e[0],i=e[1];Vue.component(n,Vue.options.components[i])}),Vue.component("v-marker",Vue2Leaflet.Marker),Vue.component("v-poly",Vue2Leaflet.Polyline),Vue.component("v-group",Vue2Leaflet.LayerGroup),Vue.component("v-map",Vue2Leaflet.Map),Vue.component("v-color-picker",VueColor.Chrome),Vue.component("v-tilelayer",Vue2Leaflet.TileLayer),$("#template-container").load("templates/templates.html",function(){app=new Vue({el:"#app",mounted:function(){this.$nextTick(function(){})},data:function(){var e=urlParams(),n={settings:{sidebar:!0,story:!1,chart:!0,model:null,repository:""},colorToggleOptions:[{icon:"colorize",value:"color"},{icon:"color_lens",value:"palette"}],colorType:"color",color:t,palette:[],pipeline:null,model:null,sketch:null,sidebar:!1};return _.assign(n.settings,e),n},methods:{onColorChange:function(t){this.color=t,this.sketch.palette=[val2rgbaString(t)]}},computed:{map:{get:function(){return _.get(this.$refs,"map.mapObject")},cache:!1},zoom:{get:function(){return _.get(this,"model.view.zoom",5)},cache:!1},center:{get:function(){var t=[0,0];if(_.has(this,"model.extent.sw")){var e=this.model,n=L.latLng(e.extent.sw[0],e.extent.sw[1]),i=L.latLng(e.extent.ne[0],e.extent.ne[1]);t=[(n.lat+i.lat)/2,(n.lng+i.lng)/2]}return t=_.get(this,"model.view.center",t)},cache:!1}}}),bus.$on("model-selected",function(t){Vue.set(app,"model",t)}),bus.$on("palette-selected",function(t){Vue.set(app,"palette",t)}),bus.$on("model-layer-added",function(){}),bus.$on("sketch-created",function(t){Vue.set(app,"sketch",t)}),bus.$on("pipeline-created",function(t){Vue.set(app,"pipeline",t)})})})}();