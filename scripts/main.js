function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}!function(e,t){"object"==typeof exports?module.exports=t(e,e.document):"function"==typeof define&&define.amd?define(function(){return t(e,e.document)}):e.Sketch=t(e,e.document)}(this,function(e,t){"use strict";function n(e){return"[object Array]"==Object.prototype.toString.call(e)}function i(e){return"function"==typeof e}function a(e){return"number"==typeof e}function r(e){return"string"==typeof e}function o(e){return C[e]||String.fromCharCode(e)}function s(e,t,n){for(var i in t)!n&&i in e||(e[i]=t[i]);return e}function c(e,t){return function(){e.apply(t,arguments)}}function l(e){var t={};for(var n in e)i(e[n])?t[n]=c(e[n],e):t[n]=e[n];return t}function u(e){function t(t){i(t)&&t.apply(e,[].splice.call(arguments,1))}function n(e){for(E=0;E<ee.length;E++)D=ee[E],r(D)?S[(e?"add":"remove")+"EventListener"].call(S,D,L,!1):i(D)?L=D:S=D}function a(){A(P),P=V(a),Z||(t(e.setup),Z=i(e.setup)),H||(t(e.resize),H=i(e.resize)),e.running&&!z&&(e.dt=(F=+new Date)-e.now,e.millis+=e.dt,e.now=F,t(e.update),Y&&(e.retina&&(e.save(),e.scale(Q,Q)),e.autoclear&&e.clear()),t(e.draw),Y&&e.retina&&e.restore()),z=++z%e.interval}function c(){S=K?e.style:e.canvas,O=K?"px":"",W=e.width||e.element.width,G=e.height||e.element.height,e.fullscreen&&(G=e.height=x.innerHeight,W=e.width=x.innerWidth),e.retina&&Y&&Q&&(S.style.height=G+"px",S.style.width=W+"px",W*=Q,G*=Q),S.height!==G&&(S.height=G+O),S.width!==W&&(S.width=W+O),Z&&t(e.resize)}function u(e,t){return M=t.getBoundingClientRect(),e.x=e.pageX-M.left-(x.scrollX||x.pageXOffset),e.y=e.pageY-M.top-(x.scrollY||x.pageYOffset),e.x*=t.width/M.width,e.y*=t.height/M.height,e}function d(t,n){return u(t,e.element),n=n||{},n.ox=n.x||t.x,n.oy=n.y||t.y,n.x=t.x,n.y=t.y,n.dx=n.x-n.ox,n.dy=n.y-n.oy,n}function h(e){if(e.preventDefault(),N=l(e),N.originalEvent=e,N.touches)for(q.length=N.touches.length,E=0;E<N.touches.length;E++)q[E]=d(N.touches[E],q[E]);else q.length=0,q[0]=d(N,J);return s(J,q[0],!0),N}function p(n){for(n=h(n),U=(X=ee.indexOf(R=n.type))-1,e.dragging=!!/down|start/.test(R)||!/up|end/.test(R)&&e.dragging;U;)r(ee[U])?t(e[ee[U--]],n):r(ee[X])?t(e[ee[X++]],n):U=0}function f(n){j=n.keyCode,B="keyup"==n.type,te[j]=te[o(j)]=!B,t(e[n.type],n)}function m(n){e.autopause&&("blur"==n.type?k:v)(),t(e[n.type],n)}function v(){e.now=+new Date,e.running=!0}function k(){e.running=!1}function T(){(e.running?k:v)()}function _(){Y&&e.clearRect(0,0,e.width,e.height)}function $(){I=e.element.parentNode,E=b.indexOf(e),I&&I.removeChild(e.element),~E&&b.splice(E,1),n(!1),k()}var P,L,S,I,M,E,O,F,D,N,R,j,B,U,X,W,G,z=0,q=[],H=!1,Z=!1,Q=x.devicePixelRatio||1,K=e.type==y,Y=e.type==g,J={x:0,y:0,ox:0,oy:0,dx:0,dy:0},ee=[e.element,p,"mousedown","touchstart",p,"mousemove","touchmove",p,"mouseup","touchend",p,"click",p,"mouseout",p,"mouseover",w,f,"keydown","keyup",x,m,"focus","blur",c,"resize"],te={};for(j in C)te[C[j]]=!1;return s(e,{touches:q,mouse:J,keys:te,dragging:!1,running:!1,millis:0,now:NaN,dt:NaN,destroy:$,toggle:T,clear:_,start:v,stop:k}),b.push(e),e.autostart&&v(),n(!0),c(),a(),e}for(var d,h,p="E LN10 LN2 LOG2E LOG10E PI SQRT1_2 SQRT2 abs acos asin atan ceil cos exp floor log round sin sqrt tan atan2 pow max min".split(" "),f="__hasSketch",m=Math,g="canvas",v="webgl",y="dom",w=t,x=e,b=[],k={fullscreen:!0,autostart:!0,autoclear:!0,autopause:!0,container:w.body,interval:1,globals:!0,retina:!1,type:g},C={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"},T={CANVAS:g,WEB_GL:v,WEBGL:v,DOM:y,instances:b,install:function(e){if(!e[f]){for(var t=0;t<p.length;t++)e[p[t]]=m[p[t]];s(e,{TWO_PI:2*m.PI,HALF_PI:m.PI/2,QUATER_PI:m.PI/4,random:function(e,t){return n(e)?e[~~(m.random()*e.length)]:(a(t)||(t=e||1,e=0),e+m.random()*(t-e))},lerp:function(e,t,n){return e+n*(t-e)},map:function(e,t,n,i,a){return(e-t)/(n-t)*(a-i)+i}}),e[f]=!0}},create:function(e){return e=s(e||{},k),e.globals&&T.install(self),d=e.element=e.element||w.createElement(e.type===y?"div":"canvas"),h=e.context=e.context||function(){switch(e.type){case g:return d.getContext("2d",e);case v:return d.getContext("webgl",e)||d.getContext("experimental-webgl",e);case y:return d.canvas=d}}(),e.exists||(e.container||w.body).appendChild(d),T.augment(h,e)},augment:function(e,t){return t=s(t||{},k),t.element=e.canvas||e,t.element.className+=" sketch",s(e,t,!0),u(e)}},_=["ms","moz","webkit","o"],$=self,P=0,L="AnimationFrame",S="request"+L,I="cancel"+L,V=$[S],A=$[I],M=0;M<_.length&&!V;M++)V=$[_[M]+"Request"+L],A=$[_[M]+"Cancel"+L];return $[S]=V=V||function(e){var t=+new Date,n=m.max(0,16-(t-P)),i=setTimeout(function(){e(t+n)},n);return P=t+n,i},$[I]=A=A||function(e){clearTimeout(e)},T}),L.CanvasOverlay=L.ImageOverlay.extend({options:{opacity:1,id:"",interactive:!0,crossOrigin:!1},initialize:function(e,t){"use strict";e?this._bounds=L.latLngBounds(e):this._bounds=null,L.setOptions(this,t)},_initImage:function(){"use strict";var e;e=this.options.el?this._image=this.options.el:this.options.id?this._image=document.getElementById(this.options.id):this._image=L.DomUtil.create("canvas","leaflet-image-layer "+(this._zoomAnimated?"leaflet-zoom-animated":"")),e.onselectstart=L.Util.falseFn,e.onmousemove=L.Util.falseFn,e.onload=L.bind(this.fire,this,"load"),this.options.crossOrigin&&(e.crossOrigin="")},_reset:function(){"use strict";L.ImageOverlay.prototype._reset.call(this);var e=this._image;e.width=this.options.width,e.height=this.options.height}}),L.canvasOverlay=function(e,t){"use strict";return new L.CanvasOverlay(e,t)},function(){"use strict";Vue.component("map-controls",{template:"#map-controls-template",props:{map:{type:Object}},data:function(){return{locked:!0}},watch:{locked:"lockedChanged"},mounted:function(){},methods:{lockedChanged:function(e,t){t?this.lockMap():this.unlockMap()},lockMap:function(){var e=this.map;e.dragging.disable(),e.touchZoom.disable(),e.doubleClickZoom.disable(),e.scrollWheelZoom.disable(),e.tap&&e.tap.disable(),$("#mapban").removeClass("hide")},unlockMap:function(){var e=this.map;e.dragging.enable(),e.touchZoom.enable(),e.doubleClickZoom.enable(),e.scrollWheelZoom.enable(),e.tap&&e.tap.enable(),$("#mapban").addClass("hide")}}}),Vue.component("toggle-controls",{template:"#toggle-controls-template",props:{sketch:{type:CanvasRenderingContext2D}},mounted:function(){var e=this,t=L.Control.extend({options:{position:"topright"},onAdd:function(){var t=e.$el,n=$('<a id="drawtoggle"></a>');n.append($('<span class="fa-stack"><i class="fa fa-paint-brush fa-stack-1x"></i><i id="drawingban" class="hide fa fa-ban fa-stack-2x"></i></span>')),n.on("click",function(){return sketch=this.sketch,this.sketch?(sketch.painting=!sketch.painting,void(sketch.painting?($("#drawing").addClass("crosshair"),$("#drawingban").addClass("hide")):($("#drawing").removeClass("crosshair"),$("#drawingban").removeClass("hide")))):void console.warn("no sketch available in",this)}),$(t).append(n);var i=$('<a id="maptoggle"></a>');return i.append($('<span class="fa-stack"><i class="fa fa-map-o fa-stack-1x"></i><i id="mapban" class="fa hide fa-ban fa-stack-2x></i></span>')),i.on("click",function(){_.has(this.$refs,"locked")?app.$refs.mapControls.locked=!app.$refs.mapControls.locked:console.warn("no mapControls available")}),$(t).append(i),t}});this.$drawToggle=new t({})},methods:{deferredMountedTo:function(e){var t=this;this.$drawToggle.addTo(e),_.forEach(this.$children,function(e){e.deferredMountedTo(t.$drawToggle)})}}}),Vue.component("canvas-layer",{template:"#canvas-layer-template",props:{model:{type:Object}},watch:{bounds:function(){this.setBounds()}},mounted:function(){var e=this.bounds;this.$drawingLayer=L.canvasOverlay(e,{el:this.$el,width:1024,height:1024})},computed:{bounds:{get:function(){var e=L.latLngBounds(L.latLng(0,0),L.latLng(1,1));if(_.has(this,"model.extent")){var t=this.model,n=L.latLng(t.extent.sw[0],t.extent.sw[1]),i=L.latLng(t.extent.ne[0],t.extent.ne[1]);e=L.latLngBounds(n,i)}return e},cache:!1}},methods:{deferredMountedTo:function(e){var t=this;this.$drawingLayer.addTo(e),_.forEach(this.$children,function(e){e.deferredMountedTo(t.$drawingLayer)})},setBounds:function(){this.$drawingLayer.setBounds(this.bounds)}}})}(),function(){"use strict";Vue.component("realtime-layer",{template:"#realtime-layer-template",props:{model:{type:Object}},data:function(){return{points:[],layerGroup:null}},watch:{points:function(){this.clearMarkers(),this.createMarkers()}},mounted:function(){var e=this,t="data/points";fetch(t).then(function(e){return e.json()}).then(function(t){Vue.set(e,"points",t)})},computed:{},methods:{deferredMountedTo:function(e){this.layerGroup=L.layerGroup([]),this.layerGroup.addTo(e)},createMarkers:function(){var e=this;_.each(this.points.features,function(t){var n=L.latLng(t.properties.lat,t.properties.lon),i=t.properties.featured?3e3:1e3,a=L.circle(n,{radius:i,color:"white",stroke:!0,weight:1,opacity:.3,fillOpacity:.5,fill:!0,fillColor:t.properties.locationColor,feature:t});a.on("click",function(t){e.setChart(t.target.options.feature)}),e.layerGroup.addLayer(a)});var t=_.first(_.filter(this.points.features,function(e){return e.properties.featured}));this.setChart(t)},clearMarkers:function(){this.layerGroup&&this.layerGroup.clearLayers()},setChart:function(e){bus.$emit("feature-selected",e)}}})}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),AdvectionFilter;!function(){"use strict";var e="\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nuniform mat3 projectionMatrix;\nuniform mat3 filterMatrix;\nvarying vec2 vTextureCoord;\nvarying vec2 vFilterCoord;\n\nvoid main(void)\n{\n   gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n   vFilterCoord = ( filterMatrix * vec3( aTextureCoord, 1.0)  ).xy;\n   vTextureCoord = aTextureCoord;\n}\n",t="\nvarying vec2 vFilterCoord;\nvarying vec2 vTextureCoord;\nuniform float decay;\nuniform vec2 scale;\nuniform bool flipv;\nuniform sampler2D uUVSampler;\nuniform sampler2D uSampler;\n\nbool isNaN(float val)\n{\n  return (val <= 0.0 || 0.0 <= val) ? false : true;\n}\n\nvoid main(void)\n{\n  // lookup in 0-1 space\n  vec2 coord = vFilterCoord;\n  // invert y if flipping\n  if (flipv) {\n    coord.y = 1.0 - coord.y;\n  }\n\n  vec4 map =  texture2D(uUVSampler, coord);\n  map -= 0.5;\n  map.xy *= scale;\n  // recompute scale if flipped\n  if (flipv) {\n    map.y = - map.y;\n  }\n\n\n\n  vec2 lookup = vec2(vTextureCoord.x - map.x, vTextureCoord.y - map.y);\n\n\n  vec4 color = texture2D(uSampler, lookup);\n  // I expected that I would have to apply this to the .a only..\n  color = vec4(color.rgb * decay, color.a * decay);\n  gl_FragColor = color;\n  if (map.z > 0.0) {\n    gl_FragColor *= 0.0;\n  }\n}";AdvectionFilter=function(n){function i(n,a){_classCallCheck(this,i);var r=new PIXI.Matrix;n.renderable=!1;var o=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,t));o.maskSprite=n,o.maskMatrix=r,o.uniforms.uUVSampler=n.texture,o.uniforms.filterMatrix=r.toArray(!0);var s=_.get(a,"scale",10);o.scale=new PIXI.Point(s,s);var c=_.get(a,"flipv",!1);o.flipv=c;var l=_.get(a,"decay",1);return o.decay=l,o}return _inherits(i,n),_createClass(i,[{key:"apply",value:function(e,t,n){_.isNaN(this.maskSprite.worldTransform.a)&&console.warn("aaahh");var i=1/n.destinationFrame.width*(n.size.width/t.size.width);this.uniforms.filterMatrix=e.calculateSpriteMatrix(this.maskMatrix,this.maskSprite),this.uniforms.scale.x=this.scale.x*i,this.uniforms.scale.y=this.scale.y*i,this.uniforms.flipv=this.flipv,this.uniforms.decay=this.decay,e.applyFilter(this,t,n)}},{key:"map",get:function(){return this.uniforms.uUVSampler},set:function(e){this.uniforms.uUVSampler=e}}]),i}(PIXI.Filter)}();var sketch;!function(){"use strict";Vue.component("drawing-controls",{template:"#drawing-controls-template",props:["sketch"],data:function(){return{}}}),Vue.component("drawing-canvas",{template:"<div></div>",data:function(){return{canvas:null,sketch:null}},mounted:function(){var e=this;this.addDrawing(),this.$nextTick(function(){bus.$emit("drawing-canvas-created",e),bus.$on("model-selected",e.clear)})},methods:{clear:function(){this.sketch.clear()},deferredMountedTo:function(e){this.canvas=e._image,this.addDrawing()},addDrawing:function(){sketch=Sketch.create({element:this.canvas,container:null,autoclear:!1,fullscreen:!1,exists:!0,palette:["black","green"],radius:3,painting:!1,hasDragged:!0,setup:function(){},update:function(){},keydown:function(e){bus.$emit("drawing-keydown",e,this)},mouseup:function(){},mousedown:function(){this.hasDragged=!1},mousemove:function(){this.hasDragged=!0},click:function(e){this.fillStyle=this.palette[Math.floor(Math.random()*this.palette.length)],this.beginPath();var t=e.x,n=e.y,i=1;this.arc(t,n,i,0,2*Math.PI),this.fill(),bus.$emit("drawing-click",this)},touchmove:function(){var e=window.DocumentTouch||this.keys.SHIFT;if(e){for(var t,n=this.touches.length-1;n>=0;n--)t=this.touches[n],this.lineCap="round",this.lineJoin="round",this.strokeStyle=this.palette[Math.floor(Math.random()*this.palette.length)],this.lineWidth=this.radius,this.beginPath(),this.moveTo(t.ox,t.oy),this.lineTo(t.x,t.y),this.stroke();bus.$emit("drawing-touchmove",this)}}}),Vue.set(this,"sketch",sketch),this.$nextTick(function(){bus.$emit("sketch-created",sketch)})}}}),$(function(){$("#images a.thumbnail").click(function(e){var t=$(e.currentTarget).find("img").attr("src"),n=new Image;n.onload=function(){sketch.drawImage(n,0,0)},n.src=t,e.preventDefault()})})}(),function(){"use strict";Vue.component("model-details",{template:"#model-details-template",props:["model"],data:function(){return{}}}),Vue.component("models-overview",{template:"#models-overview-template",data:function(){return{models:[]}},mounted:function(){var e=this;fetch("data/models.json").then(function(e){return e.json()}).then(function(t){e.models=t.models;var n=_.first(_.filter(e.models,["id",e.$root.settings.model]));_.isNil(n)&&(n=_.first(e.models)),e.selectModel(n)})["catch"](function(e){console.warn("parsing failed",e)})},methods:{selectModel:function(e){var t=new CustomEvent("model-selected",{detail:e});document.dispatchEvent(t),bus.$emit("model-selected",e)}}})}(),function(){"use strict";function e(e,t,n){this.model=e,this.canvas=t,this.uv=n,this.width=t.width,this.height=t.height,this.particleAlpha=.8,this.replace=!0,this.particles=[],this.counter=0,this.offScreen=document.createElement("canvas"),this.offScreen.width=this.canvas.width,this.offScreen.height=this.canvas.height}e.prototype.startAnimate=function(){function e(){requestAnimationFrame(e.bind(this)),i=Date.now(),t=i-a,t<r||this.particles.length&&(this.step(60/n),this.render(),a=i-t%r)}var t,n=15,i=Date.now(),a=Date.now(),r=1e3/n;e.bind(this)()},e.prototype.create=function(){var e=new PIXI.Sprite;return e.anchor.set(.5),e.alpha=this.particleAlpha,e.x=Math.random()*this.width,e.y=Math.random()*this.height,e},e.prototype.clear=function(){this.particles=[]},e.prototype.culling=function(e){for(var t=this.particles.length,n=e,i=t-1;i>=n;i--)_.pullAt(this.particles,i),this.sprites.removeChildAt(i);for(var a=0;a<n-t;a++){var r=this.create();this.particles.push(r)}},e.prototype.step=function(e){var t=this;if(this.particles.length&&!this.uv.paused&&!this.uv.ended){var n=$("#uv-hidden")[0],i=n.getContext("2d"),a=n.width,r=n.height,o=i.getImageData(0,0,a,r);_.each(this.particles,function(n){var i=4*(Math.round(r-n.position.y)*a+Math.round(n.position.x)),s=o.data[i+0]/255-.5,c=o.data[i+1]/255-.5;c*=t.model.flipv?1:-1;var l=o.data[i+2]/255>.5;l=l||Math.abs(s)+Math.abs(c)===0,n.position.x=n.position.x+s*t.model.uniforms.scale*e,n.position.y=n.position.y+c*t.model.uniforms.scale*e,l=l||n.position.x>a,l=l||n.position.x<0,l=l||n.position.y>r-1,l=l||n.position.y<10,l=l||isNaN(n.position.x),l=l||isNaN(n.position.y);var u=Math.atan2(c,s)-.5*Math.PI,d=u-n.rotation,h=.1;if(Math.abs(d)>h&&(d=d>0?h:-h),n.rotation+=d,l&&(_.pull(t.particles,n),t.replace)){var p=t.create();t.particles.push(p)}},this),this.counter++}},e.prototype.render=function(){var e=this.canvas.getContext("2d"),t=this.canvas.width,n=this.canvas.height,i=3,a=this.offScreen.getContext("2d");a.clearRect(0,0,t,n),a.globalAlpha=.95,a.drawImage(this.canvas,0,0),e.clearRect(0,0,t,n),e.fillStyle="rgba(255, 91, 126, 0.5)",e.beginPath(),_.each(this.particles,function(t){e.moveTo(t.x+i,t.y),e.arc(t.x,t.y,i,0,2*Math.PI)}),e.closePath(),e.fill(),e.globalCompositeOperation="destination-over",e.drawImage(this.offScreen,0,0)},Vue.component("particle-component",{template:"#particle-component-template",props:["model"],data:function(){return{particles:null,pipeline:null,stage:null,renderer:null,canvas:null}},mounted:function(){bus.$on("model-selected",this.resetParticles)},watch:{"model.uv":"resetParticles",pipeline:"resetParticles"},computed:{width:{get:function(){return _.get(this,"canvas.width")}},height:{get:function(){return _.get(this,"canvas.height")}}},methods:{deferredMountedTo:function(t){if(this.canvas=t._image,!_.isNil(this.model)){var n=$("#uv-"+this.model.uv.tag)[0];this.particles=new e(this.model,this.canvas,n),this.particles.startAnimate()}},resetParticles:function(){if(!_.isNil(this.model)){var t=$("#uv-"+this.model.uv.tag)[0];this.particles=new e(this.model,this.canvas,t),this.particles.startAnimate(),this.addParticles()}},addParticles:function(){_.isNil(this.model)||_.isNil(this.particles)||this.particles.culling(this.particles.particles.length+50)},removeParticles:function(){this.model.particles.culling(0)}}})}(),function(){"use strict";Vue.component("uv-source",{template:"#uv-source-template",props:{model:{type:Object,required:!1}},data:function(){return{loaded:!1}},mounted:function(){function e(){if(requestAnimationFrame(e.bind(this)),i=Date.now(),t=i-a,this.video&&this.uvctx){var n=this.video.width,o=this.video.height;this.uvctx.drawImage(this.video,0,0,n,o),a=i-t%r}}var t,n=10,i=Date.now(),a=Date.now(),r=1e3/n;this.$nextTick(function(){}),e.bind(this)()},watch:{uv:function(e){var t=this,n=this.video;n.src=e.src,n.height=e.height,n.width=e.width,"video"===this.model.uv.tag&&(this.video.currentTime=this.video.currentTime,$(this.video).bind("loadeddata",function(){t.loaded=!0,Vue.set(t.model,"duration",t.video.duration)}),$(this.video).bind("timeupdate",function(){Vue.set(t.model,"currentTime",t.video.currentTime)})),n.load(),bus.$emit("video-loaded",n)}},computed:{tag:{get:function(){return _.get(this,"model.uv.tag","video")},cache:!1},uv:{get:function(){return this.model?this.model.uv:null},cache:!1},video:{get:function(){return document.getElementById("uv-video")},cache:!1},uvctx:{get:function(){var e=document.getElementById("uv-hidden");return e.getContext("2d")},cache:!1},img:{get:function(){return document.getElementById("uv-img")},cache:!1}}}),Vue.component("model-canvas",{template:"<div>model</div>",props:{model:{type:Object,required:!1},sketch:{type:CanvasRenderingContext2D,required:!1}},data:function(){return{state:"STOPPED",drawingTexture:null,videoElement:null,videoSprite:null,stage:null,renderer:null,renderTextureFrom:null,renderTextureTo:null,pipeline:null,advectionFilter:null}},mounted:function(){var e=this;bus.$on("video-loaded",function(e){this.createVideoTexture(e),this.checkAndRun()}.bind(this)),Vue.nextTick(function(){bus.$on("model-selected",e.clear3d)})},computed:{width:{get:function(){return _.get(this,"canvas.width")}},height:{get:function(){return _.get(this,"canvas.height")}},drawing:{get:function(){return _.get(this,"sketch")},cache:!1}},watch:{"model.uniforms":function(){this.updateUniforms()},drawing:function(e){e&&(this.createDrawingTexture(e),this.checkAndRun())}},methods:{checkAndRun:function(){this.videoSprite&&this.drawingSprite&&(this.advectionFilter||(this.createFilter(),this.startAnimate(),this.updateUniforms()))},clear3d:function(){_.isNil(this.renderTextureFrom)||this.renderer.clear()},deferredMountedTo:function(e){this.canvas=e._image,this.createRenderer()},createRenderer:function(){var e=new PIXI.WebGLRenderer(this.width,this.height,{view:this.canvas,transparent:!0,clearBeforeRender:!1,preserveDrawingBuffer:!1}),t=new PIXI.Container,n=new PIXI.Container;Vue.set(this,"pipeline",n),Vue.set(this,"stage",t),Vue.set(this,"renderer",e)},createVideoTexture:function(e){var t=PIXI.Texture.fromVideo(e),n=new PIXI.Sprite(t);if(n.width=this.width,n.height=this.height,this.videoSprite){var i=this.stage.getChildIndex(this.videoSprite);this.stage.removeChildAt(i),this.stage.addChildAt(n,i)}else this.stage.addChild(n);this.videoSprite=n,this.advectionFilter&&(this.advectionFilter.map=n.texture),n.renderable=!1,this.stage.addChild(this.videoSprite)},createDrawingTexture:function(e){if(!e)return void console.warn("Expected a drawing canvas");var t=e,n=PIXI.Texture.fromCanvas(e.element),i=new PIXI.Sprite(n);this.drawingContext=t,this.drawingSprite=i,this.drawingTexture=n},updateUniforms:function(){if(this.advectionFilter&&this.model){var e=this.model;this.advectionFilter.scale.x=e.uniforms.scale,this.advectionFilter.scale.y=e.uniforms.scale,this.advectionFilter.flipv=e.uniforms.flipv,this.advectionFilter.decay=e.uniforms.decay}},createFilter:function(){var e=this,t=this.videoSprite,n=this.width,i=this.height;this.stage.addChild(this.pipeline),this.pipeline.addChild(this.drawingSprite);var a=new AdvectionFilter(t,{scale:1,flipv:!1,decay:.99,upwind:!1});this.stage.addChild(t),this.pipeline.filters=[a];var r=PIXI.RenderTexture.create(n,i),o=new PIXI.Sprite(r),s=PIXI.RenderTexture.create(n,i);this.renderTextureFrom=r,this.renderTextureTo=s,this.renderSpriteFrom=o,this.pipeline.addChild(o),this.pipeline.addChild(this.drawingSprite),this.advectionFilter=a,this.$nextTick(function(){bus.$emit("pipeline-created",e.pipeline)})},stopAnimage:function(){this.state="STOPPED"},startAnimate:function(){function e(){if("STOPPED"!==l&&(requestAnimationFrame(e.bind(this)),t=this.videoSprite,t.texture.valid&&t.texture.baseTexture.hasLoaded)){var h=t.texture.baseTexture.source;if(!(h.readyState<h.HAVE_ENOUGH_DATA)&&s.children.indexOf(t)!==-1){n.update(),i.render(s),i.render(s,a,!0),c.clearRect(0,0,u.element.width,u.element.height),o.texture=a;var p=r;r=a,a=p,i.render(d,a,!0)}}}this.state="STARTED";var t=this.videoSprite,n=this.drawingTexture,i=this.renderer,a=this.renderTextureTo,r=this.renderTextureFrom,o=this.renderSpriteFrom,s=this.stage,c=this.drawingContext,l=this.state,u=this.drawing,d=new PIXI.Container;e.bind(this)(),$("#clear3d").click(this.clear3d)}}})}(),function(){"use strict";function e(){var e=[];d3.selectAll("circle.active").each(function(t){var n=d3.rgb(255*t.rgb[0],255*t.rgb[1],255*t.rgb[2]);e.push(n)}),_.isNil(sketch)||(sketch.palette=e)}Vue.component("painting-palettes",{template:"#paintings-template",data:function(){return{paintings:[]}},mounted:function(){var e=this;fetch("data/paintings.json").then(function(e){return e.json()}).then(function(t){e.paintings=t,e.select(e.paintings[0])})},methods:{select:function(e){bus.$emit("palette-selected",e.palette)}}}),Vue.component("palette-chart",{template:"#palette-chart-template",data:function(){return{}},props:{palette:{type:Array,"default":function(){return[]}}},mounted:function(){this.$watch("palette",function(){this.updateChart()})},methods:{updateChart:function(){var t=300,n=200,i=d3.select("#palette").select("svg"),a=i.select("g");i.attr("width",t).attr("height",n);var r=d3.scaleLinear().range([0,t]).domain([-.1,1.1]).nice(),o=d3.scaleLinear().range([n,0]).domain([-.1,1.1]).nice();a.selectAll("circle").remove(),a.selectAll("circle").data(this.palette).enter().append("circle").attr("cx",function(e){return r(e.x)}).attr("cy",function(e){return o(e.y)}).attr("r",10).style("fill",function(e){return d3.rgb(255*e.rgb[0],255*e.rgb[1],255*e.rgb[2])}).on("click",function(){d3.select(this).classed("active",!d3.select(this).classed("active")),e()}),a.selectAll("circle").classed("active",!0),e()}}}),document.addEventListener("model-loaded",function(){e()})}(),function(){"use strict";Vue.component("key-bindings",{template:"#key-bindings-template",data:function(){var e=this,t=this.$root;return{keyBindings:[{key:"p",description:"Particles",method:function(){_.has(t,"$refs.particleComponent.addParticles")&&t.$refs.particleComponent.addParticles()},arguments:{}},{key:"c",method:function(){e.clear()},description:"Clear canvas",arguments:{}},{key:"q",description:"Quiver like plot",method:function(e,t){_.isNil(t)||_.each(_.range(0,100),function(){var e=1024*Math.random(),n=1024*Math.random();t.strokeStyle="white",t.beginPath(),t.arc(e,n,1,0,2*Math.PI),t.closePath(),t.stroke()})}},{key:"g",description:"Grid plot",method:function(e,t){_.isNil(t)||_.each(_.range(0,1024,Math.pow(2,7)),function(e){t.strokeStyle="black",t.beginPath(),t.moveTo(e,0),t.lineTo(e,1024),t.closePath(),t.stroke(),t.beginPath(),t.moveTo(0,e),t.lineTo(1024,e),t.closePath(),t.stroke()})}}]}},mounted:function(){window.addEventListener("keyup",this.keyUp),bus.$on("drawing-keydown",this.drawingKey)},methods:{drawingKey:function(e,t){var n=_.first(_.filter(this.keyBindings,["key",e.key]));_.isNil(n)||n.method(e,t)},keyUp:function(e){var t=_.first(_.filter(this.keyBindings,["key",e.key]));_.isNil(t)||t.method(t.arguments)},clear:function(){var e=this.$root;e.$refs.particleComponent.removeParticles(),_.has(e.$refs,"drawingCanvas")&&(e.$refs.drawingCanvas.clear(),console.warn("Expected drawingCanvas on",e.$refs)),_.has(e.$refs,"modelCanvas")&&(e.$refs.modelCanvas.clear3d(),console.warn("Expected modelCanvas on",e.$refs))}}})}(),function(){"use strict";Vue.component("story-container",{template:"#story-container-template",data:function(){return{storyUrl:"data/stories/ecomare.json",story:null}},mounted:function(){var e=this;this.$nextTick(function(){var t=new ScrollMagic.Controller({container:e.$el,loglevel:3});console.log("adding story to ",e.$el);var n=e.$root;fetch(e.storyUrl).then(function(e){return e.json()}).then(function(i){Vue.set(e,"story",i),e.$nextTick(function(){var a=e.$el.getElementsByClassName("story-item");_.each(a,function(e,a){var r=i.items[a];console.log("combining",e,"with",r,e.clientHeight);var o=new ScrollMagic.Scene({triggerElement:e,duration:e.clientHeight}).on("enter",function(){console.log("entering item",r),_.has(r,"latlng")&&n.$refs.map.mapObject.flyTo(L.latLng(r.latlng),r.zoom)}).addIndicators().addTo(t);console.log("add scene",o)});var r=Array.from(e.$el.getElementsByClassName("jssor-slider-container"));_.map(r,function(e){var t=new $JssorSlider$(e.id,{$AutoPlay:!0});return t})})})})}})}(),function(){"use strict";Vue.component("chart-container",{template:"#chart-container-template",props:["model"],data:function(){return{series:[],limits:[],chart:null}},mounted:function(){var e=this;this.createChart(),bus.$on("feature-selected",function(t){var n="data/details/"+t.properties.locationCode;fetch(n).then(function(e){return e.json()}).then(function(t){Vue.set(e,"series",t.series),Vue.set(e,"limits",_.get(t,"limits",[]))})}),this.$nextTick(function(){this.updateChart()})},watch:{progress:function(e){var t=[{x:e,y:0},{x:e,y:1}];this.chart.pathProgress.datum(t).attr("d",this.chart.lineProgress)},series:function(){this.updateChart()},model:function(){this.updateChart()}},computed:{progress:{cache:!1,get:function(){if(!_.has(this.model,"currentTime"))return 0;var e=this.model.currentTime/this.model.duration;return e}}},methods:{updateChart:function(){var e=this;if(this.model){var t=_.map(this.model.extent.time,d3.isoParse);if(this.chart.xTime.domain(t),this.chart.yWaterlevel.domain(this.model.extent.waterlevel),this.chart.xAxis.call(d3.axisBottom(this.chart.xTime)),this.chart.yAxis.call(d3.axisLeft(this.chart.yWaterlevel)),this.series.length){this.chart.g.selectAll(".series").remove(),this.chart.g.selectAll(".limits").remove(),this.chart.g.selectAll(".limits").data(this.limits).enter().append("rect").attr("class","limits").attr("x",function(){var t=d3.isoParse(e.model.extent.time[0]);return e.chart.xTime(t)}).attr("y",function(t){var n=e.model.extent.waterlevel[1];return _.isNil(t.to)||(n=t.to/100),e.chart.yWaterlevel(n)}).attr("width",function(){var t=d3.isoParse(e.model.extent.time[1]),n=d3.isoParse(e.model.extent.time[0]),i=e.chart.xTime(t)-e.chart.xTime(n);return i}).attr("height",function(t){var n=e.model.extent.waterlevel[0];_.isNil(t.from)||(n=t.from/100);var i=e.model.extent.waterlevel[1];_.isNil(t.to)||(i=t.to/100);var a=e.chart.yWaterlevel(n)-e.chart.yWaterlevel(i);return a<0?0:a}).style("fill",function(e){return e.color}).style("opacity",.2);var n=this.chart.g.selectAll(".series").data(this.series).enter().append("g").attr("class","series"),i=d3.line().x(function(t){var n=d3.isoParse(t.dateTime),i=e.chart.xTime(n);return i}).y(function(t){var n=e.chart.yWaterlevel(t.value/100);return n});n.append("path").attr("class","line waterlevel").attr("d",function(e){return i(e.data)}).style("stroke",function(e){return e.color})}}},createChart:function(){var e={top:14,right:24,bottom:28,left:34},t=this.$el.clientWidth-e.left-e.right,n=this.$el.clientHeight-e.top-e.bottom,i=d3.scaleTime().range([0,t]),a=d3.scaleLinear().range([0,t]),r=d3.scaleLinear().range([n,0]),o=d3.scaleLinear().range([n,0]),s=d3.select(this.$el).append("svg");s.attr("width",t+e.left+e.right).attr("height",n+e.top+e.bottom);var c=s.append("g").attr("transform","translate("+e.left+","+e.top+")"),l=c.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+n+")"),u=c.append("g").attr("class","axis axis--y");u.append("text").attr("class","axis-title").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("waterlevel [cm]");var d=[{x:this.progress,y:0},{x:this.progress,y:1}],h=d3.line().x(function(e){return a(e.x)}).y(function(e){return r(e.y)}),p=c.datum(d).append("path").attr("class","line").attr("d",h),f={svg:s,g:c,xTime:i,xLinear:a,yWaterlevel:o,yLinear:r,width:t,height:n,xAxis:l,yAxis:u,lineProgress:h,pathProgress:p};Vue.set(this,"chart",f)}}})}();var app,bus;!function(){"use strict";function e(){for(var e,t=/\+/g,n=/([^&=]+)=?([^&]*)/g,i=function(e){return decodeURIComponent(e.replace(t," "))},a=window.location.search.substring(1),r={};null!==(e=n.exec(a));){var o=i(e[2]),s=null;s="true"===o||"false"!==o&&o,r[i(e[1])]=s}return r}$(document).ready(function(){bus=new Vue,Vue.use(Vuetify),Vue.component("v-marker",Vue2Leaflet.Marker),Vue.component("v-poly",Vue2Leaflet.Polyline),Vue.component("v-group",Vue2Leaflet.LayerGroup),Vue.component("v-map",Vue2Leaflet.Map),Vue.component("v-tilelayer",Vue2Leaflet.TileLayer),$("#template-container").load("templates/templates.html",function(){app=new Vue({el:"#app",mounted:function(){this.$nextTick(function(){})},data:function(){var t=e(),n={settings:{sidebar:!1,story:!1,chart:!0,model:null},palette:[],pipeline:null,model:null,map:null,sketch:null};return _.assign(n.settings,t),n},methods:{}}),bus.$on("model-selected",function(e){Vue.set(app,"model",e),Vue.nextTick(function(){var t=L.latLng(e.extent.sw[0],e.extent.sw[1]),n=L.latLng(e.extent.ne[0],e.extent.ne[1]),i=L.latLngBounds(t,n);_.has(app.$refs,"map")?app.$refs.map.mapObject.flyToBounds(i):console.warn("fitBounds missing",app.$refs,app,i)})}),bus.$on("palette-selected",function(e){Vue.set(app,"palette",e);
}),bus.$on("model-layer-added",function(){}),bus.$on("sketch-created",function(e){Vue.set(app,"sketch",e)}),bus.$on("pipeline-created",function(e){Vue.set(app,"pipeline",e)})})})}();